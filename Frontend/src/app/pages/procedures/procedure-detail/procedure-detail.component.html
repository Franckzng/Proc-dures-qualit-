<!-- src/app/pages/procedures/procedure-detail/procedure-detail.component.html -->
<ng-container *ngIf="!loading && procedure; else loadingTemplate">
  <div class="container my-4 procedure-doc">

    <!-- Zone d'export/impression (sans pièces jointes) -->
    <div id="procedure-print-area" class="paper-area">
      <!-- En-tête avec logo et informations -->
      <div class="letterhead d-flex align-items-start justify-content-between mb-3">
        <div class="letterhead-left">
          <img [src]="logoUrl" alt="Logo" class="logo" style="max-height:60px;">
        </div>

        <div class="letterhead-center text-center" style="flex:1; padding:0 1rem;">
          <div class="doc-type">Procédure</div>
          <div class="doc-title">
            <div class="title h4">{{ procedure.titre }}</div>
            <div class="doc-sub text-muted">{{ procedure.description }}</div>
          </div>
        </div>

        <div class="letterhead-right text-end">
          <div><strong>Code:</strong> {{ procedure.code || '—' }}</div>
          <div><strong>Version:</strong> {{ procedure.version }}</div>
          <div><strong>Statut:</strong> {{ getStatusDisplay(procedure.statut) }}</div>
        </div>
      </div>

      <!-- Section des opérations chronologiques -->
      <div class="section-header mb-3">
        <h5>OPERATIONS CHRONOLOGIQUES</h5>
      </div>

      <!-- Liste des étapes formatée hiérarchiquement -->
      <div class="operations-list mb-4">
        <ng-container *ngTemplateOutlet="stepsTemplate; context: { steps: steps, level: 0 }"></ng-container>
      </div>

      <ng-container *ngIf="!steps.length">
        <div class="text-center py-4">
          <i class="bi bi-list-task text-muted fs-1 mb-3"></i>
          <p class="text-muted">Aucune étape définie pour cette procédure.</p>
        </div>
      </ng-container>
          <!-- Traitement d'une étape (mini UI) -->
    <section *ngIf="currentStep" class="mb-4">
      <h5>Traiter cette étape</h5>
      <p class="small text-muted">Ordre: {{ currentStep.ordre }} — Statut: {{ currentStep.statut }}</p>
      <div class="mb-2">
        <label class="form-label">Commentaire</label>
        <textarea class="form-control" [(ngModel)]="processComment"></textarea>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-success" (click)="processCurrentStep('VALIDE')">Valider</button>
        <button class="btn btn-danger" (click)="processCurrentStep('REJETE')">Rejeter</button>
      </div>
    </section>
      <!-- Tableau des signatures -->
      <section *ngIf="(procedure.statut === 'APPROUVEE' || procedure.statut === 'PUBLIEE') && fullWorkflow" class="mb-4">
        <div class="signature-table">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th style="width: 33.33%;">Rédacteur</th>
                <th style="width: 33.33%;">Vérificateur</th>
                <th style="width: 33.33%;">Approbateur</th>
              </tr>
            </thead>
            <tbody>
              <tr style="height: 120px; vertical-align: top;">
                <td class="p-3">
                  <div class="signature-cell">
                    <div class="signature-info">
                      <strong>{{ procedure.redacteur_nom }} {{ procedure.redacteur_prenom }}</strong>
                    </div>
                    <div class="signature-date">
                      <small>Date : {{ procedure.date_creation | date:'dd/MM/yyyy' }}</small>
                    </div>
                    <div class="signature-line">
                      <small>Visa :</small>
                    </div>
                  </div>
                </td>
                <td class="p-3">
                  <div class="signature-cell" *ngIf="fullWorkflow.etapes?.[0]; else emptySignature">
                    <div class="signature-info">
                      <strong>{{ fullWorkflow.etapes[0].user_nom }} {{ fullWorkflow.etapes[0].user_prenom }}</strong>
                    </div>
                    <div class="signature-date" *ngIf="fullWorkflow.etapes[0].date_traitement">
                      <small>Date : {{ fullWorkflow.etapes[0].date_traitement | date:'dd/MM/yyyy' }}</small>
                    </div>
                    <div class="signature-line">
                      <small>Visa :</small>
                    </div>
                  </div>
                  <ng-template #emptySignature>
                    <div class="signature-cell">
                      <div class="signature-info">—</div>
                      <div class="signature-date"><small>Date :</small></div>
                      <div class="signature-line"><small>Visa :</small></div>
                    </div>
                  </ng-template>
                </td>
                <td class="p-3">
                  <div class="signature-cell" *ngIf="fullWorkflow.etapes?.[1]; else emptySignature2">
                    <div class="signature-info">
                      <strong>{{ fullWorkflow.etapes[1].user_nom }} {{ fullWorkflow.etapes[1].user_prenom }}</strong>
                    </div>
                    <div class="signature-date" *ngIf="fullWorkflow.etapes[1].date_traitement">
                      <small>Date : {{ fullWorkflow.etapes[1].date_traitement | date:'dd/MM/yyyy' }}</small>
                    </div>
                    <div class="signature-line">
                      <small>Visa :</small>
                    </div>
                  </div>
                  <ng-template #emptySignature2>
                    <div class="signature-cell">
                      <div class="signature-info">—</div>
                      <div class="signature-date"><small>Date :</small></div>
                      <div class="signature-line"><small>Visa :</small></div>
                    </div>
                  </ng-template>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div> <!-- Fin de la zone d'export/impression -->

    <!-- Pièces jointes (NE SERONT PAS incluses dans l'export/impression) -->
    <ng-container *ngIf="attachments.length">
      <h5>Pièces jointes ({{ attachments.length }})</h5>
      <div class="row g-3 mb-4">
        <div *ngFor="let att of attachments" class="col-6 col-md-3">
          <div class="attachment-card border rounded p-2 d-flex flex-column h-100">
            <img *ngIf="att.mime_type.startsWith('image/')" [src]="att.url" [alt]="att.original_name" class="img-fluid rounded mb-2 flex-grow-1 object-fit-contain">
            <video *ngIf="att.mime_type.startsWith('video/')" controls class="w-100 mb-2 rounded flex-grow-1">
              <source [src]="att.url" [type]="att.mime_type">
            </video>
            <div *ngIf="!att.mime_type.startsWith('image/') && !att.mime_type.startsWith('video/')" class="flex-grow-1 mb-2 d-flex align-items-center justify-content-center">
              <i class="bi bi-paperclip fs-1 text-muted"></i>
            </div>
            <a [href]="att.url" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary mt-auto">{{ att.original_name }}</a>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Boutons d'action (NE SERONT PAS inclus dans l'export/impression) -->
    <div class="d-flex justify-content-end mt-4 no-print" [class.export-hidden]="exporting">
      <button class="btn btn-outline-secondary me-2" routerLink="/dashboard/procedures">Retour</button>
      <button class="btn btn-primary me-2" [disabled]="!canEdit()" [routerLink]="['/dashboard/procedures/edit', procedure.id]">Modifier</button>

      <!-- Export only for approved/published -->
      <button *ngIf="procedure.statut === 'APPROUVEE' || procedure.statut === 'PUBLIEE'"
              class="btn btn-success me-2"
              (click)="exportPdf()"
              [disabled]="exporting">
        <i class="bi bi-file-earmark-pdf me-1"></i>Exporter (PDF)
      </button>

      <button class="btn btn-outline-dark me-2" (click)="print()" [disabled]="exporting">Imprimer</button>

      <button class="btn btn-danger" [disabled]="!canEdit()" (click)="delete()">Supprimer</button>
    </div>

  </div>
</ng-container>

<ng-template #loadingTemplate>
  <div class="d-flex flex-column align-items-center py-5">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement…</span></div>
    <p class="mt-3">Chargement des détails de la procédure…</p>
  </div>
</ng-template>

<!-- Template récursif pour les étapes (doit être à l'extérieur de la zone d'export) -->
<ng-template #stepsTemplate let-steps="steps" let-level="level">
  <ng-container *ngFor="let step of steps">
    <div class="operation-item" [class]="'level-' + level">
      <div class="operation-content">
        <span class="operation-bullet">{{ getBulletType(level) }}</span>
        <span class="operation-text">{{ step.contenu || 'Étape vide' }}</span>
      </div>
    </div>
    <ng-container *ngIf="step.children?.length">
      <ng-container *ngTemplateOutlet="stepsTemplate; context: { steps: step.children, level: level + 1 }"></ng-container>
    </ng-container>
  </ng-container>
</ng-template>